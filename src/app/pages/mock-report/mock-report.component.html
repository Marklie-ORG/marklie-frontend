<div class="dashboard">
  <div class="config-step1">
    <h3>Report Schedule</h3>

    <div *ngIf="scheduleSaved" class="alert alert-success" role="alert">
      Schedule saved successfully!
    </div>


    <div class="form-row">
      <label>Date Preset:</label>
      <select class="form-control" [(ngModel)]="selectedDatePresetText">
        <option *ngFor="let preset of DATE_PRESETS" [value]="preset.value">
          {{ preset.text }}
        </option>
      </select>
    </div>


    <div class="form-row">
      <label>Schedule Frequency:</label>
      <select class="form-control" [(ngModel)]="schedule.frequency">
        <option value="weekly">Weekly</option>
        <option value="biweekly">Biweekly</option>
        <option value="monthly">Monthly</option>
        <option value="custom">Custom</option>
        <option value="cron">Cron</option>
      </select>
    </div>


    <div class="form-row" *ngIf="['weekly', 'biweekly'].includes(schedule.frequency)">
      <label>Day of Week:</label>
      <select class="form-control" [(ngModel)]="schedule.dayOfWeek">
        <option *ngFor="let day of DAYS_OF_WEEK" [value]="day">{{ day }}</option>
      </select>
    </div>

    <div class="form-row" *ngIf="schedule.frequency === 'monthly'">
      <label>Day of Month:</label>
      <input type="number" class="form-control" [(ngModel)]="schedule.dayOfMonth" min="1" max="31" />
    </div>

    <div class="form-row" *ngIf="schedule.frequency === 'custom'">
      <label>Every X Days:</label>
      <input type="number" class="form-control" [(ngModel)]="schedule.intervalDays" min="1" />
    </div>

    <div class="form-row" *ngIf="schedule.frequency === 'cron'">
      <label>Cron Expression:</label>
      <input type="text" class="form-control" [(ngModel)]="schedule.cronExpression" />
    </div>

    <div class="form-row" *ngIf="schedule.frequency !== 'cron'">
      <label>Time:</label>
      <input type="time" class="form-control" [(ngModel)]="schedule.time" step="300" />
    </div>


    <i class="fa-light fa-question"></i>
    <div class="form-row d-flex align-items-center">
      <label for="reviewBeforeSend" class="mb-0">
        Require review before sending
        <i
          class="fa-solid fa-question"
          title="You will be notified to review the generated report before itâ€™s sent to the client."
          style="cursor: pointer; position: relative; top: -5px;"
        ></i>
      </label>
      <input
        type="checkbox"
        id="reviewBeforeSend"
        [(ngModel)]="schedule.reviewNeeded"
        class="me-2 ms-2"
      />
    </div>

    <button class="btn btn-success" (click)="saveConfiguration()">Save Configuration</button>
  </div>

  <main class="report-content">
    <h2 class="section-title mb-4">Mock Report Preview</h2>
    <div *ngIf="reportStatsLoading" class="loading text-center">Loading...</div>

    <div *ngIf="!reportStatsLoading" cdkDropList (cdkDropListDropped)="dropSection($event)">
      <div *ngFor="let section of reportSections; let i = index" cdkDrag class="report-section bordered-section">
        <div class="section-toggle">
          <label>{{ section.title }}</label>
          <label class="switch">
            <input type="checkbox" [(ngModel)]="panelToggles[section.key]" (change)="onPanelToggleChange()" />
            <span class="slider round"></span>
          </label>
        </div>

        <div *ngIf="panelToggles[section.key]">
          <div class="metric-group" cdkDropList [cdkDropListData]="section.metrics"
               (cdkDropListDropped)="dropMetric($event, i)">
            <div *ngFor="let metric of section.metrics; let j = index" cdkDrag>
              <label>
                <input type="checkbox" [(ngModel)]="metricSelections[section.key][metric]" (change)="onMetricSelectionChange()" />
                {{ formatMetricLabel(metric) }}
              </label>
            </div>
          </div>

          <ng-container [ngSwitch]="section.key">
            <div *ngSwitchCase="'kpis'" class="kpi-grid" cdkDropList (cdkDropListDropped)="dropKPICard($event)">
              <ng-container *ngFor="let metric of section.metrics">
                <div class="kpi-card" *ngIf="metricSelections.kpis[metric]" cdkDrag>
                  <div class="kpi-label">{{ formatMetricLabel(metric) }}</div>
                  <div class="kpi-value" [ngClass]="getMetricStyle(metric)">
                    {{ formatMetricValue(metric, KPIs[metric]) }}
                  </div>
                </div>
              </ng-container>
            </div>


            <div *ngSwitchCase="'graphs'" class="graph-grid" cdkDropList (cdkDropListDropped)="dropGraphCard($event)">
              <div class="graph-card" *ngFor="let config of metricsGraphConfig" cdkDrag>
                <canvas [id]="config.key + 'Chart'"></canvas>
              </div>
            </div>

            <div *ngSwitchCase="'ads'" class="ad-grid">
              <div class="ad-card" *ngFor="let ad of ads">
                <div class="ad-image-container">
                  <img class="ad-media" [src]="ad.thumbnailUrl" [alt]="ad.name" />
                </div>
                <div class="metrics">
                  <div class="metric" *ngFor="let key of section.metrics">
                    <ng-container *ngIf="metricSelections.ads[key]">
                      <div class="metric-label">{{ formatMetricLabel(key) }}</div>
                      <div class="metric-value" [ngClass]="getMetricStyle(key)">
                        {{ formatMetricValue(key, ad[key]) }}
                      </div>
                    </ng-container>
                  </div>

                </div>
                <a target="_blank" [href]="ad.sourceUrl" class="view-ad-btn">View Ad</a>
              </div>
            </div>

            <div *ngSwitchCase="'campaigns'" class="table-container">
              <table class="campaign-table">
                <thead>
                <tr cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="dropCampaignColumn($event)">
                  <th>#</th>
                  <th>Campaign Name</th>
                  <th *ngFor="let key of campaignColumnOrder" cdkDrag>
                    {{ formatMetricLabel(key) }}
                  </th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let campaign of campaigns; let k = index">
                  <td>{{ k + 1 }}</td>
                  <td>{{ campaign.campaign_name }}</td>
                  <td *ngFor="let key of campaignColumnOrder">
                    {{ formatMetricValue(key, campaign[key]) }}
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </main>
</div>
