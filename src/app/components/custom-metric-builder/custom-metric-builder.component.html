<modal-base>
  <div class="builder-body">
    <div class="builder-column builder-column--details">
      <h4>Details</h4>
      <div class="builder-form">
        <label class="builder-field">
          <span class="builder-field-label">Formula name</span>
          <input
            type="text"
            [(ngModel)]="formulaName"
            (input)="onNameInput()"
            placeholder="Enter formula name"
          />
          @if (formulaNameError) {
            <span class="field-error">{{ formulaNameError }}</span>
          }
        </label>

        <label class="builder-field">
          <span class="builder-field-label">Description (optional)</span>
          <textarea
            rows="3"
            [(ngModel)]="formulaDescription"
            placeholder="Describe what this formula does"
          ></textarea>
        </label>

        <label class="builder-field">
          <span class="builder-field-label">Format</span>
          <select [(ngModel)]="selectedFormat">
            @for (option of formatOptions; track option.value) {
              <option [value]="option.value">{{ option.label }}</option>
            }
          </select>
        </label>
      </div>
    </div>

    <div class="builder-column">
      <h4>Metrics</h4>
      <div
        cdkDropList
        id="metricsList"
        [cdkDropListData]="metrics"
        [cdkDropListConnectedTo]="['formulaList']"
        [cdkDropListEnterPredicate]="disallowDrop"
        cdkDropListSortingDisabled
        class="palette"
      >
        @if (!metrics.length) {
          <p class="empty-state">No metrics available.</p>
        } @else {
          @for (metric of metrics; track metric.name) {
            <div
              cdkDrag
              class="palette-item"
              (click)="onMetricClick(metric)"
            >
              <span class="palette-item-label">{{ metricsService.getFormattedMetricName(metric.name) }}</span>
              <span class="palette-item-tag">{{ metric.isCustom ? 'Custom' : 'Default' }}</span>
            </div>
          }
        }
      </div>

      <h4>Operations</h4>
      <div
        cdkDropList
        id="operationsList"
        [cdkDropListData]="mathOperations"
        [cdkDropListConnectedTo]="['formulaList']"
        [cdkDropListEnterPredicate]="disallowDrop"
        cdkDropListSortingDisabled
        class="operations"
      >
        @for (operation of mathOperations; track operation) {
          <div
            cdkDrag
            class="palette-item palette-operation"
            (click)="onOperationClick(operation)"
          >
            {{ operation }}
          </div>
        }
      </div>
    </div>

    <div class="builder-column formula-column">
      <h4>Formula builder</h4>
      <div
        cdkDropList
        id="formulaList"
        [cdkDropListData]="formulaTokens"
        [cdkDropListConnectedTo]="['metricsList', 'operationsList']"
        class="formula-dropzone"
        (cdkDropListDropped)="onFormulaDrop($event)"
      >
        @if (!formulaTokens.length) {
          <p class="empty-state">Drag or click metrics and operations to add them</p>
        }
        @for (token of formulaTokens; track $index) {
          <div cdkDrag class="formula-token">
            <span>{{ token.label }}</span>
            <button type="button" class="token-remove" (click)="removeToken($index)">Ã—</button>
          </div>
        }
      </div>

      <h4>Formula preview</h4>
      <textarea
        id="formulaDisplay"
        class="formula-preview"
        rows="3"
        [value]="formulaDisplay"
        readonly
      ></textarea>

      @if (errorMessage) {
        <p class="error-message">{{ errorMessage }}</p>
      }

      <div class="builder-actions">
        @if (showDeleteButton) {
          <button type="button" class="danger" (click)="onDelete()">Delete</button>
        }
        <button type="button" class="secondary" (click)="clearFormula()">Clear</button>
        <button type="button" class="primary" (click)="onSave()">{{ actionButtonLabel }}</button>
      </div>
    </div>
  </div>
</modal-base>
