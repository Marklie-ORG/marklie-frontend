<div class="side-panel d-flex flex-column p-3">
  <!-- Main Navigation -->
  @if (toggles.main) {
    <div class="d-flex flex-column gap-3">
      <item
        [hideDrag]="true"
        [title]="'Header'"
        (click)="togglePage('header')"
      ></item>
    
      <div #sectionsContainer class="d-flex flex-column gap-3">
        @for (section of reportSections(); track section.key) {
          <item
            [style.opacity]="section.enabled ? 1 : 0.5"
            [title]="section.title"
            (click)="togglePage(section.key)"
          ></item>
        }
      </div>
    </div>
  }
  
  <!-- Header Section -->
  @if (toggles.header) {
    <div>
      <div class="d-flex align-items-center justify-between gap-2 pl-2 pr-2">
        <div class="d-flex align-items-center gap-2">
          <img 
            class="cursor-pointer"
            src="../../../assets/img/icons/arrow_left.svg" 
            alt="Back to main" 
            (click)="togglePage('main')"
          >
          <p class="ml-2">Header</p>
        </div>
      </div>
    
      <div class="metric-group mt-2 pt-3 d-flex flex-column gap-2">
        <input 
          class="text"
          type="text" 
          placeholder="Report title" 
          [(ngModel)]="reportTitle" 
          (keyup)="reportTitleChange.emit(reportTitle)"
        >
      </div>
    </div>
  }
  
  <!-- Metrics Sections (KPIs, Graphs, Ads, Campaigns) -->
  @if (toggles.kpis && mainKPIs) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Main KPIs', 
                    data: mainKPIs, 
                    sectionKey: 'kpis' 
                  }">
    </ng-container>
  }
  
  @if (toggles.graphs && graphs) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Graphs', 
                    data: graphs, 
                    sectionKey: 'graphs' 
                  }">
    </ng-container>
  }
  
  @if (toggles.ads && bestCreatives) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Best creatives', 
                    data: bestCreatives, 
                    sectionKey: 'ads' 
                  }">
    </ng-container>
  }
  
  @if (toggles.campaigns && bestCampaigns) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Best campaigns', 
                    data: bestCampaigns, 
                    sectionKey: 'campaigns' 
                  }">
    </ng-container>
  }
</div>

<!-- Reusable Metrics Section Template -->
<ng-template #metricsSection let-title="title" let-data="data" let-sectionKey="sectionKey">
  <div>
    <div class="d-flex align-items-center justify-between gap-2 pl-2 pr-2">
      <div class="d-flex align-items-center gap-2 cursor-pointer" (click)="togglePage('main')">
        <img 
          src="../../../assets/img/icons/arrow_left.svg" 
          alt="Back to main" 
        >
        <p class="ml-2">{{ title }}</p>
      </div>
      
      <div>
        <label class="switch">
          <input 
            type="checkbox" 
            [(ngModel)]="data.enabled" 
            (change)="onMetricsChange(data, sectionKey)"
            (click)="$event.stopPropagation()"
          />
          <span class="slider round"></span>
        </label>
      </div>
    </div>
  
    <div class="metrics-container">
      <!-- Ad Account Selection -->
      @if (!selectedAdAccountId) {
        @for (adAccount of data.adAccounts; track adAccount.id) {
          <item
            [style.opacity]="adAccount.enabled ? 1 : 0.5"
            [title]="adAccount.name"
            (click)="toggleSelectedAdAccount(adAccount.id)"
          ></item>
        }
      }
      
      <!-- Ad Account Details -->
      @for (adAccount of data.adAccounts; track adAccount.id) {
        @if (selectedAdAccountId === adAccount.id) {
          <div>
            <h4 class="mb-2 mt-2">{{ adAccount.name }}</h4>

            <label class="switch">
              <input 
                type="checkbox" 
                [(ngModel)]="adAccount.enabled" 
                (change)="onMetricsChange(data, sectionKey)"
                (click)="$event.stopPropagation()"
              />
              <span class="slider round"></span>
            </label>

            <div class="metric-group mt-2 pt-2 d-flex flex-column gap-2">
              @for (metric of adAccount.metrics; track metric.name) {
                <label class="prevent-select" 
                  [ngClass]="{ 'obligatory-metric': sectionKey === 'ads' && metric.name === 'impressions' }"
                  (click)="onObligatoryMetricClick($event, sectionKey, metric)">
                  <input 
                  type="checkbox" 
                  [(ngModel)]="metric.enabled" 
                  (change)="onMetricsChange(data, sectionKey)"
                  [disabled]="sectionKey === 'ads' && metric.name === 'impressions'"
                  />
                  <span class="checkmark"></span>
                  {{ metric.name }}
                </label>
              }
            </div>
          </div>
        }
      }
    </div>
  </div>
</ng-template>