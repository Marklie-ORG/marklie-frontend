<div class="billing-page container mt-4">
  <h2>Plans & Billing</h2>

  <div class="plans-wrapper">

    <div class="current-plan-actions" *ngIf="currentPlanId()">
      <h4>Manage current plan</h4>
  
      <div class="current-plan-row">
        <div class="label">Plan</div>
        <div class="value">{{ getCurrentPlan()?.name || '—' }}</div>
      </div>
  
      <div class="current-plan-row">
        <div class="label">Status</div>
        <div class="value">{{ renewalDateLabel() }}</div>
      </div>
  
      <div class="actions">
        <button class="btn outline" (click)="cancelAtEnd()" [disabled]="cancellingLater() || cancellingNow() || resuming()">
          {{ cancellingLater() ? 'Scheduling…' : 'Cancel at period end' }}
        </button>
  
        <button class="btn danger" (click)="cancelNow()" [disabled]="cancellingNow() || cancellingLater() || resuming()">
          {{ cancellingNow() ? 'Cancelling…' : 'Cancel immediately' }}
        </button>
  
        <button class="btn primary" *ngIf="cancelAtPeriodEnd()" (click)="resumeIfScheduled()"
                [disabled]="resuming() || cancellingLater() || cancellingNow()">
          {{ resuming() ? 'Resuming…' : 'Resume subscription' }}
        </button>
  
        <span class="hint">“Cancel at period end” keeps access until the current cycle ends. “Cancel immediately” stops access now.</span>
      </div>
    </div>
    
    <div class="toggle-row mt-4">
      <div class="period-toggle" role="tablist" aria-label="Billing period">
        <div class="segmented">
          <button [class]="period() === 'monthly' ? 'active' : ''" (click)="setPeriod('monthly')">Pay monthly</button>
          <button [class]="period() === 'yearly' ? 'active' : ''" (click)="setPeriod('yearly')">Pay yearly</button>
        </div>
        <a class="save-hint">Save up to 20% with yearly</a>
      </div>
    </div>
  
    <div class="plans-grid">
      @for (p of plans(); track p.id) {
        <div class="plan-card" [class.current]="isCurrent(p)">
  
          <div class="plan-header">
            <div class="title">{{ p.name }}</div>
          </div>
  
          @if (!isCustom(p)) {
            <div class="price">
              <span class="value">{{ p.price | currency:'USD' }}</span>
              <span class="per">/ {{ p.interval }}</span>
            </div>
          }
          @else {
            <div class="price"><span class="value">Custom pricing</span></div>
          }
  
          <div class="cta">
            @if (isCurrent(p)) {
              <div class="current">
                <div class="label">Current Plan</div>
                <div class="renew">{{ renewalDateLabel() }}</div>
              </div>
            } 
            @else {
              @if (p.price > 0) {
                <button 
                class="blue"
                [disabled]="!canChangeTo(p)"
                (click)="goToCheckout(p.id)"
                >
                  {{ getActionLabel(p) }}
                </button>
              } @else {
                <button class="blue" disabled>Contact Sales</button>
              }
            }
          </div>
          
          
  
          <ul class="features">
            <li><img src="assets/img/billing_blue_checkmark.svg"> {{ clientRange(p) }}</li>
            <li><img src="assets/img/billing_blue_checkmark.svg"> {{ teamRange(p) }}</li>
            <li><img src="assets/img/billing_blue_checkmark.svg"> {{ refreshLabel(p) }}</li>
  
            <li *ngIf="p.features.customization"><img src="assets/img/billing_blue_checkmark.svg"> Report customization</li>
            <li *ngIf="p.features.metaIntegration"><img src="assets/img/billing_blue_checkmark.svg"> Meta integration</li>
            <li *ngIf="p.features.tiktokIntegration"><img src="assets/img/billing_blue_checkmark.svg"> Tiktok integration</li>
            <li *ngIf="p.features.publishedLinks"><img src="assets/img/billing_blue_checkmark.svg"> Published links</li>
            <li *ngIf="p.features.loomIntegration"><img src="assets/img/billing_blue_checkmark.svg"> Loom integration</li>
            <li *ngIf="p.features.aiDescription"><img src="assets/img/billing_blue_checkmark.svg"> AI description</li>
            <li *ngIf="p.features.marklyBadge"><img src="assets/img/billing_blue_checkmark.svg"> Markly badge</li>
          </ul>
        </div>
      }
    </div>
  </div>

  <!-- <div class="mt-4" style="width:95%">
    <app-plans-compare
      [plans]="plans()"
      [currentPlanId]="currentPlanId()"
      (selectPlan)="goToCheckout($event)">
    </app-plans-compare>
  </div> -->


  <div class="invoices">
    <div class="invoices-header"><h2>Previous invoices</h2></div>
    @for (inv of invoices(); track inv.id) {
      <div class="invoice-row">
        <div class="name">{{ inv.name }}</div>
        <div class="date">{{ inv.date }}</div>
        <div class="plan">{{ inv.plan }}</div>
        <div class="amount">{{ inv.amount }}</div>
        <div class="actions" *ngIf="inv.canDownload">
          <button class="icon"><fa-icon [icon]="faDownload"></fa-icon></button>
        </div>
      </div>
    }
  </div>
</div>
