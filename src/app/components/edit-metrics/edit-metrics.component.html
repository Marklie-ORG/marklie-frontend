<div class="side-panel d-flex flex-column p-3">
  <!-- Main Navigation -->
  @if (toggles.main) {
    <div class="d-flex flex-column gap-3">
      <item
        [title]="'Settings'"
        (click)="togglePage('header')"
      ></item>
    
      <div #sectionsContainer class="d-flex flex-column gap-3">
        @for (section of reportSections(); track section.key) {
          <item
            [style.opacity]="section.enabled ? 1 : 0.5"
            [title]="section.title"
            [showDrag]="true"
            (click)="togglePage(section.key)"
          ></item>
        }
      </div>
    </div>
  }
  
  <!-- Header Section -->
  @if (toggles.header) {
    <div>
      <div class="d-flex align-items-center justify-between gap-2 pl-2 pr-2">
        <div class="d-flex align-items-center gap-2">
          <img 
            class="cursor-pointer"
            src="../../../assets/img/icons/arrow_left.svg" 
            alt="Back to main" 
            (click)="togglePage('main')"
          >
          <p class="ml-2">Header</p>
        </div>
      </div>
    
      <div class="metric-group mt-2 pt-3 d-flex flex-column gap-2">
        <input 
          class="text"
          type="text" 
          placeholder="Report title" 
          [(ngModel)]="reportTitle" 
          (keyup)="reportTitleChange.emit(reportTitle)"
        >
        <div class="d-flex flex-column align-items-center gap-3 mt-2">
          <label class="d-flex align-items-center gap-2">
            <span style="width: 16px; height: 16px; border-radius: 3px; border: 1px solid #ccc; display: inline-block;" [style.background-color]="headerBackgroundColor()"></span>
            <span>Header color</span>
            <input type="color" [value]="headerBackgroundColor()" (input)="headerBackgroundColor.set(($any($event.target)).value)">
          </label>
          <label class="d-flex align-items-center gap-2">
            <span style="width: 16px; height: 16px; border-radius: 3px; border: 1px solid #ccc; display: inline-block;" [style.background-color]="reportBackgroundColor()"></span>
            <span>Report color</span>
            <input type="color" [value]="reportBackgroundColor()" (input)="reportBackgroundColor.set(($any($event.target)).value)">
          </label>
        </div>
      </div>
    </div>
  }
  
  <!-- Metrics Sections (KPIs, Graphs, Ads, Campaigns) -->
  @if (toggles.kpis && mainKPIs) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Main KPIs', 
                    data: mainKPIs, 
                    sectionKey: 'kpis' 
                  }">
    </ng-container>
  }
  
  @if (toggles.graphs && graphs) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Graphs', 
                    data: graphs, 
                    sectionKey: 'graphs' 
                  }">
    </ng-container>
  }
  
  @if (toggles.ads && bestCreatives) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Best creatives', 
                    data: bestCreatives, 
                    sectionKey: 'ads' 
                  }">
    </ng-container>
  }
  
  @if (toggles.campaigns && bestCampaigns) {
    <ng-container [ngTemplateOutlet]="metricsSection" 
                  [ngTemplateOutletContext]="{ 
                    title: 'Best campaigns', 
                    data: bestCampaigns, 
                    sectionKey: 'campaigns' 
                  }">
    </ng-container>
  }
</div>

<!-- Reusable Metrics Section Template -->
<ng-template #metricsSection let-title="title" let-data="data" let-sectionKey="sectionKey">
  <div>
    <div class="d-flex align-items-center justify-between gap-2 pl-2 pr-2">
      <div class="d-flex align-items-center gap-2 cursor-pointer" (click)="togglePage('main')">
        <img 
          src="../../../assets/img/icons/arrow_left.svg" 
          alt="Back to main" 
        >
        <p class="ml-2">{{ title }}</p>
      </div>
      
      <div>
        <label class="switch">
          <input 
            type="checkbox" 
            [(ngModel)]="data.enabled" 
            (change)="onMetricsChange(data, sectionKey)"
            (click)="$event.stopPropagation()"
          />
          <span class="slider round"></span>
        </label>
      </div>
    </div>
  
    <div class="metrics-container">
      <!-- Ad Account Selection -->
      @if (!selectedAdAccountId) {
        @for (adAccount of data.adAccounts; track adAccount.id) {
          <item
            [style.opacity]="adAccount.enabled ? 1 : 0.5"
            [title]="adAccount.name"
            (click)="toggleSelectedAdAccount(adAccount.id)"
          ></item>
        }
      }
      
      <!-- Ad Account Details -->
      @for (adAccount of data.adAccounts; track adAccount.id) {
        @if (selectedAdAccountId === adAccount.id) {
          <div>
            <h4 class="mb-2 mt-2">{{ adAccount.name }}</h4>

            <label class="switch">
              <input 
                type="checkbox" 
                [(ngModel)]="adAccount.enabled" 
                (change)="onMetricsChange(data, sectionKey)"
                (click)="$event.stopPropagation()"
              />
              <span class="slider round"></span>
            </label>

            <!-- todo: test reordering before commiting -->
            <div class="metric-group mt-2 pt-2 d-flex flex-column gap-2">
              <p class="mt-2">Default metrics</p>
              @for (metric of adAccount.metrics; track metric.name) {
                @if (!metric.isCustom && !metric.isCustomFormula) {
                  <label class="prevent-select">
                    <input 
                    type="checkbox" 
                    [(ngModel)]="metric.enabled" 
                    (change)="onMetricsChange(data, sectionKey)"
                    />
                    <span class="checkmark"></span>
                    {{ getFormattedMetricName(metric.name) }}
                  </label>
                }
              }
              <p class="mt-2">Custom metrics</p>
              @for (metric of adAccount.metrics; track metric.name) {
                @if (metric.isCustom) {
                  <label class="prevent-select">
                    <input 
                    type="checkbox" 
                    [(ngModel)]="metric.enabled" 
                    (change)="onMetricsChange(data, sectionKey)"
                    />
                    <span class="checkmark"></span>
                    {{ getFormattedMetricName(metric.name) }}
                  </label>
                }
              }

              <p class="mt-2">Custom formulas</p>
              @for (metric of adAccount.metrics; track metric.name) {
                @if (metric.isCustomFormula) {
                  <label class="prevent-select">
                    <input 
                    type="checkbox" 
                    [(ngModel)]="metric.enabled" 
                    (change)="onMetricsChange(data, sectionKey)"
                    />
                    <span class="checkmark"></span>
                    {{ getFormattedMetricName(metric.name) }}
                  </label>
                }
              }

              <button
                type="button"
                class="create-custom-metric-btn mt-3"
                (click)="openCustomMetricBuilder(adAccount, sectionKey)"
              >
                Create custom metric
              </button>
              
            </div>
          </div>
        }
      }
    </div>
  </div>
</ng-template>

@if (isCustomMetricBuilderOpen()) {
  <custom-metric-builder
    [metrics]="customMetricBuilderMetrics"
    [adAccountName]="customMetricBuilderAccountName"
    (cancel)="closeCustomMetricBuilder()"
    (save)="handleCustomMetricSave($event)"
  ></custom-metric-builder>
}
